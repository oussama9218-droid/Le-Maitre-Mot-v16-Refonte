<analysis>**original_problem_statement:**
The user is enhancing a Math exercise sheet generator, Le-Maitre-Mot-v16-Refonte. The work in this session involved several sequential user-defined sprints:

1.  **FIGURES_FUSION & FIXES (V2, V3, V4):** The initial goal was to fix the integration of legacy geometric figures (SVG/HTML) into the app's preview and PDF exports (Standard & Pro). This involved debugging the entire data pipeline from the backend legacy generator to the frontend preview modal and the PDF rendering engines (Standard and Pro). Multiple bugs were fixed, including incorrect method calls, improper data mapping, and incorrect HTML rendering in Jinja2 templates due to missing  filters.

2.  **CHAPTER MIGRATION (SPRINT 1):** A major data migration task to move the application's chapter structure from a hardcoded Python dictionary () to a new, comprehensive MongoDB collection named . This involved creating a new data model and service, and executing a migration script to populate the collection with ~170 chapters (collège & lycée) from a user-provided CSV. The API was updated to read from this new collection while ensuring 100% backward compatibility.

3.  **EXERCISE TYPE MIGRATION (SPRINT 2):** A soft migration to link existing  documents to the new  collection. This was done by adding a new optional  field to the  model and running a migration script to back-fill this field for 40 out of 47 existing exercises, based on matching  with .

4.  **API ENHANCEMENT & TESTING (SPRINT 3):** To begin leveraging the new data structure, the main exercise listing endpoint () was updated to accept an optional  filter. A documentation file was created for the 7 unmapped exercises, and initial integration tests were added.

5.  **DEDICATED ENDPOINT (SPRINT 4):** The current task is to create a new, dedicated RESTful endpoint  to provide a clean way to fetch exercises for a specific chapter. This sprint also requires adding robust API tests using FastAPI's .

**User's preferred language**: French

**what currently exists?**
- A full-stack React/FastAPI/MongoDB application for generating math exercise sheets.
- The FIGURES_FUSION feature, which embeds SVG figures into exercises, is now largely functional after extensive debugging.
- A new MongoDB collection  exists, containing ~170 structured chapters for middle school (collège) and high school (lycée).
- The  model in MongoDB now includes an optional  field, which has been populated for ~85% of existing exercises.
- The API endpoint  reads from the new  collection.
- The API endpoint  supports an optional  filter.
- Basic integration tests and documentation for the recent migrations are in place.

**Last working item**:
-   **Last item agent was working**: The agent was about to begin **SPRINT 4: Endpoint dédié GET /api/chapters/{chapter_code}/exercise-types + tests API**. The agent had acknowledged the user's prompt for this sprint but had not yet written any code for the new endpoint or the associated tests.
-   **Status**: NOT STARTED
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: Backend testing agent using FastAPI's , as explicitly requested by the user. The agent should create a new test file  and implement the tests described in SPRINT 4.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   Issue 1: Recurring Environment Instability (P0)
-   Issue 2: Standard PDF Export Structure Bug (P1)
-   Issue 3: Broken  Setup (P2)

**Issues Detail:**
-   **Issue 1:**
    -   **Description**: The backend container frequently fails to start because the  system dependency (required by WeasyPrint) is missing. The agent has had to manually install this package multiple times during the session.
    -   **Attempted fixes**: Manual Reading package lists...
Building dependency tree...
Reading state information...
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded. in each new environment. The root cause (why the dependency is not part of the base environment) has not been addressed.
    -   **Next debug checklist**:
        1.  Do not just manually install the package. Investigate how to make the installation permanent.
        2.  Check for a  in the workspace. If it exists, add .
        3.  If no  is accessible, investigate the reliability of the  script. Add logging to it and ensure it runs with sufficient permissions at startup.
    -   **Why fix this issue and what will be achieved with the fix?**: This is a critical, high-frequency blocker that wastes time and prevents any smooth development or testing workflow. A permanent fix will stabilize the entire environment.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on other issue**: None

-   **Issue 2:**
    -   **Description**: An earlier user report indicated that the Standard PDF export merges multiple exercises into a single Exercice 1. This was mentioned again in a user sprint (). The agent reviewed the code and believed it to be correct but did not perform a definitive test to confirm the fix.
    -   **Attempted fixes**: None directly. The agent worked on adjacent PDF code but never focused on this structural bug.
    -   **Next debug checklist**:
        1.  Create a sheet with 2-3 distinct exercises.
        2.  Generate the Standard PDF via the UI.
        3.  Inspect the downloaded PDF to see if exercises are correctly numbered and separated.
        4.  If the bug persists, debug the loop in  and  in .
    -   **Why fix this issue and what will be achieved with the fix?**: This is a core functionality bug. Fixing it makes the Standard PDF export usable.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on other issue**: Issue 1 (Environment Instability)

-   **Issue 3:**
    -   **Description**: The original handoff mentioned that automated backend tests using  were broken, failing with  errors. This forces reliance on manual testing.
    -   **Attempted fixes**: None. The agent created new tests in a separate file using a different approach ().
    -   **Next debug checklist**: Review  and existing test files to understand the source of the  error. This is lower priority as the new  approach works.
    -   **Why fix this issue and what will be achieved with the fix?**: Enables a more robust and comprehensive test suite for long-term stability.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on other issue**: None

**In progress Task List**:
-   Task 1: Implement SPRINT 4 (P0)

 **Task Detail:**
  -   **Task 1:**
     -   **Where to resume**: Start implementing Tâche 1 of SPRINT 4. Create the new endpoint  in . Then, proceed with Tâche 2 (create API tests with ) and Tâche 3 (create documentation).
     -   **What will be achieved with this?**: This will create a clean, dedicated, and tested API for fetching exercises based on the new, structured chapter codes, advancing the application's architecture.
     -   **Status**: IN PROGRESS
     -   **Should Test frontend/backend/both after fix?**: Backend
     -   **Blocked on something**: Issue 1 (Recurring Environment Instability) is a constant risk.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **P1:** Fix Standard PDF export structure (Issue 2).
    -   **P2:** Manually map the 7  documents that were not migrated automatically, based on the analysis in .
    -   **P3:** Find a permanent solution for the  dependency issue (Issue 1).
-   **Future Tasks**:
    -   Implement an improved HTML-based preview (user mentioned Sprint F.5).
    -   Optimize PDF/SVG generation time.
    -   Implement Thematic Premium Mode.
    -   Extend the system to other subjects (French, History, etc.).
    -   Enhance the frontend with a commercial-focused landing page.
    -   Fix the original  test setup (Issue 3).

**Completed work in this session**
-   **FIGURES_FUSION Sprint (Debug & Completion)**: Fixed numerous bugs in the backend legacy exercise generator and data converters to correctly generate and pass  to the frontend and PDF engines.
-   **PDF Pro Template Fixes**: Corrected all Jinja2 Pro templates (, , etc.) to use the  filter, fixing corrupted PDF outputs that showed raw HTML.
-   **Chapter Data Migration**: Created a new  collection in MongoDB and successfully migrated ~170 chapters from a user-provided CSV, including a mapping between new and legacy domain names.
-   **ExerciseType Soft Migration**: Extended the  model with  and ran a migration script to successfully link 40/47 existing exercises to the new chapter structure.
-   **API Enhancements**: Updated  to use the new DB collection and added an optional  filter to .
-   **Testing & Documentation**: Created initial integration tests, a mapping service, and documentation for unmapped exercises and new tests.

**Earlier issues found/mentioned but not fixed**
   - **Issue 1:** Standard PDF Export Structure Bug. See All Pending/In progress Issue list.
   - **Issue 2:** Broken  Setup. See All Pending/In progress Issue list.

**Known issue recurrence from previous fork**
  - **Issue recurrence in previous fork**: Backend startup failure due to missing  dependency.
  - **Recurrence count**: High (at least 4 times this session).
  - **Status**: NOT STARTED (No permanent fix has been attempted).

**Code Architecture**
| safe

**Key Technical Concepts**
-   **Data Migration**: Migrating a hardcoded dictionary and a large CSV file into a new, structured MongoDB collection ().
-   **Backward-Compatible API Design**: Evolving API endpoints by adding optional filters () and sourcing data from new collections while preserving the original response contract to avoid breaking the frontend.
-   **Soft Data Linking**: Adding an optional  field to the  model and back-filling it, allowing old () and new systems to coexist.
-   **Jinja2 Template Safety**: Correctly rendering raw HTML/SVG content within Jinja2 templates by applying the  filter to prevent auto-escaping.
-   **FastAPI TestClient**: The user-preferred method for writing robust API integration tests.

**key DB schema**
-   **chapters**: 
-   **exercise_types**:  + 
-   **user_templates**: 
-   **mathalea_exercise_sheets**: 

**changes in tech stack**
-   No fundamental changes. ============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.2, pluggy-1.6.0
rootdir: /app
plugins: asyncio-1.2.0, anyio-4.10.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 143 items / 8 errors

==================================== ERRORS ====================================
_______ ERROR collecting backend/tests/test_api_generate_integration.py ________
backend/tests/test_api_generate_integration.py:13: in <module>
    from server import app
backend/server.py:19: in <module>
    import weasyprint
/root/.venv/lib/python3.11/site-packages/weasyprint/__init__.py:433: in <module>
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/weasyprint/css/__init__.py:28: in <module>
    from .computed_values import COMPUTER_FUNCTIONS
/root/.venv/lib/python3.11/site-packages/weasyprint/css/computed_values.py:9: in <module>
    from ..text.ffi import FROM_UNITS, ffi, pango
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:491: in <module>
    pangoft2 = _dlopen(
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:463: in _dlopen
    return ffi.dlopen(names[0], flags)  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:150: in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:834: in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:829: in _load_backend_lib
    raise OSError(msg)
E   OSError: cannot load library 'libpangoft2-1.0-0': libpangoft2-1.0-0: cannot open shared object file: No such file or directory.  Additionally, ctypes.util.find_library() did not manage to locate a library called 'libpangoft2-1.0-0'
------------------------------- Captured stdout --------------------------------

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----

___________ ERROR collecting backend/tests/test_catalogue_unifie.py ____________
backend/tests/test_catalogue_unifie.py:19: in <module>
    from server import app
backend/server.py:19: in <module>
    import weasyprint
/root/.venv/lib/python3.11/site-packages/weasyprint/__init__.py:433: in <module>
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/weasyprint/css/__init__.py:28: in <module>
    from .computed_values import COMPUTER_FUNCTIONS
/root/.venv/lib/python3.11/site-packages/weasyprint/css/computed_values.py:9: in <module>
    from ..text.ffi import FROM_UNITS, ffi, pango
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:491: in <module>
    pangoft2 = _dlopen(
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:463: in _dlopen
    return ffi.dlopen(names[0], flags)  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:150: in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:834: in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:829: in _load_backend_lib
    raise OSError(msg)
E   OSError: cannot load library 'libpangoft2-1.0-0': libpangoft2-1.0-0: cannot open shared object file: No such file or directory.  Additionally, ctypes.util.find_library() did not manage to locate a library called 'libpangoft2-1.0-0'
------------------------------- Captured stdout --------------------------------

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----

_____ ERROR collecting backend/tests/test_exercise_template_generation.py ______
backend/tests/test_exercise_template_generation.py:15: in <module>
    from server import app
backend/server.py:19: in <module>
    import weasyprint
/root/.venv/lib/python3.11/site-packages/weasyprint/__init__.py:433: in <module>
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/weasyprint/css/__init__.py:28: in <module>
    from .computed_values import COMPUTER_FUNCTIONS
/root/.venv/lib/python3.11/site-packages/weasyprint/css/computed_values.py:9: in <module>
    from ..text.ffi import FROM_UNITS, ffi, pango
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:491: in <module>
    pangoft2 = _dlopen(
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:463: in _dlopen
    return ffi.dlopen(names[0], flags)  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:150: in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:834: in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:829: in _load_backend_lib
    raise OSError(msg)
E   OSError: cannot load library 'libpangoft2-1.0-0': libpangoft2-1.0-0: cannot open shared object file: No such file or directory.  Additionally, ctypes.util.find_library() did not manage to locate a library called 'libpangoft2-1.0-0'
------------------------------- Captured stdout --------------------------------

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----

________ ERROR collecting backend/tests/test_mathalea_ai_enrichment.py _________
backend/tests/test_mathalea_ai_enrichment.py:26: in <module>
    from server import app
backend/server.py:19: in <module>
    import weasyprint
/root/.venv/lib/python3.11/site-packages/weasyprint/__init__.py:433: in <module>
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/weasyprint/css/__init__.py:28: in <module>
    from .computed_values import COMPUTER_FUNCTIONS
/root/.venv/lib/python3.11/site-packages/weasyprint/css/computed_values.py:9: in <module>
    from ..text.ffi import FROM_UNITS, ffi, pango
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:491: in <module>
    pangoft2 = _dlopen(
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:463: in _dlopen
    return ffi.dlopen(names[0], flags)  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:150: in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:834: in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:829: in _load_backend_lib
    raise OSError(msg)
E   OSError: cannot load library 'libpangoft2-1.0-0': libpangoft2-1.0-0: cannot open shared object file: No such file or directory.  Additionally, ctypes.util.find_library() did not manage to locate a library called 'libpangoft2-1.0-0'
------------------------------- Captured stdout --------------------------------

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----

__________ ERROR collecting backend/tests/test_mathalea_sheet_pdf.py ___________
backend/tests/test_mathalea_sheet_pdf.py:24: in <module>
    from server import app
backend/server.py:19: in <module>
    import weasyprint
/root/.venv/lib/python3.11/site-packages/weasyprint/__init__.py:433: in <module>
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/weasyprint/css/__init__.py:28: in <module>
    from .computed_values import COMPUTER_FUNCTIONS
/root/.venv/lib/python3.11/site-packages/weasyprint/css/computed_values.py:9: in <module>
    from ..text.ffi import FROM_UNITS, ffi, pango
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:491: in <module>
    pangoft2 = _dlopen(
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:463: in _dlopen
    return ffi.dlopen(names[0], flags)  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:150: in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:834: in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:829: in _load_backend_lib
    raise OSError(msg)
E   OSError: cannot load library 'libpangoft2-1.0-0': libpangoft2-1.0-0: cannot open shared object file: No such file or directory.  Additionally, ctypes.util.find_library() did not manage to locate a library called 'libpangoft2-1.0-0'
------------------------------- Captured stdout --------------------------------

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----

________ ERROR collecting backend/tests/test_mathalea_sheet_preview.py _________
backend/tests/test_mathalea_sheet_preview.py:23: in <module>
    from server import app
backend/server.py:19: in <module>
    import weasyprint
/root/.venv/lib/python3.11/site-packages/weasyprint/__init__.py:433: in <module>
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/weasyprint/css/__init__.py:28: in <module>
    from .computed_values import COMPUTER_FUNCTIONS
/root/.venv/lib/python3.11/site-packages/weasyprint/css/computed_values.py:9: in <module>
    from ..text.ffi import FROM_UNITS, ffi, pango
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:491: in <module>
    pangoft2 = _dlopen(
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:463: in _dlopen
    return ffi.dlopen(names[0], flags)  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:150: in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:834: in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:829: in _load_backend_lib
    raise OSError(msg)
E   OSError: cannot load library 'libpangoft2-1.0-0': libpangoft2-1.0-0: cannot open shared object file: No such file or directory.  Additionally, ctypes.util.find_library() did not manage to locate a library called 'libpangoft2-1.0-0'
------------------------------- Captured stdout --------------------------------

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----

____________ ERROR collecting backend/tests/test_mathalea_system.py ____________
backend/tests/test_mathalea_system.py:15: in <module>
    from server import app
backend/server.py:19: in <module>
    import weasyprint
/root/.venv/lib/python3.11/site-packages/weasyprint/__init__.py:433: in <module>
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/weasyprint/css/__init__.py:28: in <module>
    from .computed_values import COMPUTER_FUNCTIONS
/root/.venv/lib/python3.11/site-packages/weasyprint/css/computed_values.py:9: in <module>
    from ..text.ffi import FROM_UNITS, ffi, pango
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:491: in <module>
    pangoft2 = _dlopen(
/root/.venv/lib/python3.11/site-packages/weasyprint/text/ffi.py:463: in _dlopen
    return ffi.dlopen(names[0], flags)  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:150: in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:834: in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/cffi/api.py:829: in _load_backend_lib
    raise OSError(msg)
E   OSError: cannot load library 'libpangoft2-1.0-0': libpangoft2-1.0-0: cannot open shared object file: No such file or directory.  Additionally, ctypes.util.find_library() did not manage to locate a library called 'libpangoft2-1.0-0'
------------------------------- Captured stdout --------------------------------

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----

_______________ ERROR collecting test_ia_optimization_system.py ________________
import file mismatch:
imported module 'test_ia_optimization_system' has this __file__ attribute:
  /app/backend/tests/test_ia_optimization_system.py
which is not the same as the test file we want to collect:
  /app/test_ia_optimization_system.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
=============================== warnings summary ===============================
../root/.venv/lib/python3.11/site-packages/starlette/formparsers.py:12
  /root/.venv/lib/python3.11/site-packages/starlette/formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

../root/.venv/lib/python3.11/site-packages/emergentintegrations/payments/stripe/checkout.py:20
  /root/.venv/lib/python3.11/site-packages/emergentintegrations/payments/stripe/checkout.py:20: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator('amount')

../root/.venv/lib/python3.11/site-packages/emergentintegrations/payments/stripe/checkout.py:26
  /root/.venv/lib/python3.11/site-packages/emergentintegrations/payments/stripe/checkout.py:26: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator('quantity')

../root/.venv/lib/python3.11/site-packages/emergentintegrations/payments/stripe/checkout.py:32
  /root/.venv/lib/python3.11/site-packages/emergentintegrations/payments/stripe/checkout.py:32: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator('stripe_price_id')

backend/tests/test_massive_generators.py:15
  /app/backend/tests/test_massive_generators.py:15: PytestCollectionWarning: cannot collect test class 'TestResults' because it has a __init__ constructor (from: backend/tests/test_massive_generators.py)
    class TestResults:

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
ERROR backend/tests/test_api_generate_integration.py - OSError: cannot load l...
ERROR backend/tests/test_catalogue_unifie.py - OSError: cannot load library '...
ERROR backend/tests/test_exercise_template_generation.py - OSError: cannot lo...
ERROR backend/tests/test_mathalea_ai_enrichment.py - OSError: cannot load lib...
ERROR backend/tests/test_mathalea_sheet_pdf.py - OSError: cannot load library...
ERROR backend/tests/test_mathalea_sheet_preview.py - OSError: cannot load lib...
ERROR backend/tests/test_mathalea_system.py - OSError: cannot load library 'l...
ERROR test_ia_optimization_system.py
!!!!!!!!!!!!!!!!!!! Interrupted: 8 errors during collection !!!!!!!!!!!!!!!!!!!!
======================== 5 warnings, 8 errors in 16.61s ======================== with FastAPI  is being adopted for new tests.

**All files of reference**
-   **/app/backend/routes/mathalea_routes.py**: Target file for creating the new endpoint in SPRINT 4.
-   **/app/backend/tests/test_mathalea_api_chapter_code.py**: To be created in SPRINT 4 for API tests.
-   **/app/backend/migrations/001_migrate_chapters.py**: Contains the logic for the chapter data import.
-   **/app/backend/migrations/002_migrate_exercise_types_add_chapter_code.py**: Contains the logic for the soft migration of exercises.
-   **/app/docs/exercise_types_non_mappes.md**: Contains the analysis of the 7 exercises that failed to migrate automatically.
-   **/app/backend/engine/pdf_engine/mathalea_sheet_pdf_builder.py**: Contains the logic for Standard PDF generation, which may still have the exercise merging bug.

**key api endpoints**
-   : **MODIFIED** to read from MongoDB.
-   : **NEW** endpoint to query the chapters collection with filters.
-   : **MODIFIED** to accept an optional  query parameter.
-   : **TO BE CREATED** in the current sprint.
-   : Was debugged and is now functional for figure generation.

**Critical Info for New Agent**
-   **ENVIRONMENT IS UNSTABLE**: You will almost certainly encounter a backend startup failure due to the missing  dependency. Be prepared to run Hit:1 http://deb.debian.org/debian bookworm InRelease
Get:2 http://deb.debian.org/debian bookworm-updates InRelease [55.4 kB]
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]
Get:4 https://deb.nodesource.com/node_20.x nodistro InRelease [12.1 kB]
Get:5 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 InRelease [3005 B]
Get:6 http://deb.debian.org/debian-security bookworm-security/main arm64 Packages [285 kB]
Get:7 https://deb.nodesource.com/node_20.x nodistro/main arm64 Packages [13.2 kB]
Get:8 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0/multiverse arm64 Packages [95.4 kB]
Get:9 https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0/multiverse amd64 Packages [96.8 kB]
Fetched 609 kB in 2s (371 kB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
The following NEW packages will be installed:
  libpangoft2-1.0-0
0 upgraded, 1 newly installed, 0 to remove and 2 not upgraded.
Need to get 44.5 kB of archives.
After this operation, 178 kB of additional disk space will be used.
Get:1 http://deb.debian.org/debian bookworm/main arm64 libpangoft2-1.0-0 arm64 1.50.12+ds-1 [44.5 kB]
Fetched 44.5 kB in 0s (807 kB/s)
Selecting previously unselected package libpangoft2-1.0-0:arm64.
(Reading database ... (Reading database ... 5%(Reading database ... 10%(Reading database ... 15%(Reading database ... 20%(Reading database ... 25%(Reading database ... 30%(Reading database ... 35%(Reading database ... 40%(Reading database ... 45%(Reading database ... 50%(Reading database ... 55%(Reading database ... 60%(Reading database ... 65%(Reading database ... 70%(Reading database ... 75%(Reading database ... 80%(Reading database ... 85%(Reading database ... 90%(Reading database ... 95%(Reading database ... 100%(Reading database ... 38368 files and directories currently installed.)
Preparing to unpack .../libpangoft2-1.0-0_1.50.12+ds-1_arm64.deb ...
Unpacking libpangoft2-1.0-0:arm64 (1.50.12+ds-1) ...
Setting up libpangoft2-1.0-0:arm64 (1.50.12+ds-1) ...
Processing triggers for libc-bin (2.36-9+deb12u13) ... and restart the backend (backend: stopped
backend: started) to proceed. Finding a permanent fix for this is a high-priority background task.
-   **FOLLOW THE SPRINTS**: The user provides extremely detailed, structured sprints. Adhere to them closely, especially the non-regression constraints.
-   **BACKWARD COMPATIBILITY IS KEY**: Do not remove old fields () or change existing API response structures. The current strategy is to add new functionality (like ) alongside the old to ensure a smooth transition.
-   **TESTING METHOD**: For SPRINT 4, you must use FastAPI's  to write API tests as specified by the user.
-   **USER FOR PRO FEATURES**:  (as  header).
-   **LANGUAGE**: All user communication must be in **French**.

**documents created in this job**
-   /app/docs/exercise_types_non_mappes.md
-   /app/docs/tests_chapter_code.md

**Last 10 User Messages and any pending user messages**
1.  **User (Msg 494):** Provided SPRINT 2 prompt: Soft-migrate s by adding . (Status: COMPLETED)
2.  **Agent (Msg 524):** Confirmed completion of SPRINT 2, showing 40/47 exercises migrated. (Status: COMPLETED)
3.  **User (Msg 525):** Provided SPRINT 3 prompt: Exploit  in the API with an optional filter and add tests/documentation. (Status: COMPLETED)
4.  **Agent (Msg 553):** Confirmed completion of SPRINT 3, showing the new filter works. (Status: COMPLETED)
5.  **User (Msg 554):** Acknowledged the agent's progress and provided SPRINT 4 prompt: Create a dedicated endpoint  and add  API tests. (Status: **PENDING - THIS IS THE CURRENT TASK**)
6.  **Agent (Msg 555):** Confirmed understanding of SPRINT 4 and started work. (Status: IN PROGRESS)

**Project Health Check:**
-   **Broken**:
    -   The core environment stability is broken due to the recurring  dependency issue.
    -   The Standard PDF export may still be broken (unverified structural bug).
-   **Mocked**: The original  test suite is non-functional. New tests are being added with , which is a positive development.

**3rd Party Integrations**
-   **WeasyPrint**: Used for PDF generation. This is the source of the recurring environment instability.
-   **OpenAI GPT-4o**: Uses Emergent LLM Key. Used for optional AI features.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**:
    -   
-   **Known regressions**: The environment is unreliable and regresses on every restart, requiring manual dependency installation.

**Credentials to test flow:**
-   Use the email  as the value for the  header when testing any Pro features.

**What agent forgot to execute**
-   The agent has consistently failed to implement a *permanent* fix for the  dependency issue, opting for repeated manual installations instead of addressing the root cause.
-   The agent did not definitively test or confirm a fix for the Standard PDF export structure bug, which was reported in a previous session and mentioned again in a user prompt.</analysis>
