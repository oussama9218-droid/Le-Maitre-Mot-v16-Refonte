<analysis>**original_problem_statement:**
The user has reported several critical issues and requests during this session:
1.  **CRITICAL BUG (In Progress):** When selecting a chapter like Symétrie axiale (6e), the backend generates a completely unrelated exercise (e.g., about rectangles or decimals) instead of an exercise for that chapter. The user expects the system to either generate a relevant exercise or return a clear error, not fail silently by providing incorrect content.
2.  **BUG (Fixed):** SVG figures were not appearing in the generated PDF exports ( and ).
3.  **TASK (Done):** The user requested a complete technical audit and documentation of the entire  system.
4.  **TASK (Done):** The user requested a plan to improve the API coherence rate from ~65% to 100%, which involved temporarily bypassing the AI for problematic generators.
5.  **TASK (Done):** The user requested the secure reactivation of the AI for the Cercles generator, including a strict validation pipeline and monitoring.

**PRODUCT REQUIREMENTS:**
-   The chapter selected in the frontend must *always* correspond to the type of exercise generated by the backend.
-   If a generator for a selected chapter does not exist, the API must return an explicit, user-friendly error, not a random fallback exercise.
-   SVG figures must be correctly rendered in all PDF exports.
-   The AI-generated text must be strictly validated for coherence against the Python-generated mathematical data.
-   The application environment must be stable and not require manual intervention to start the backend.

**User's preferred language**: French

**what currently exists?**
The application is a math exercise generator with a Python backend and React frontend. A critical bug is currently being addressed where selecting a specific chapter (Symétrie axiale) results in a completely unrelated exercise being generated. The agent has identified the root causes but has not yet fully implemented the fix across the entire request-response chain.

Several key improvements were made:
-   The bug causing SVGs to be missing from PDF exports has been fixed.
-   A full technical audit document () was created.
-   A secure pipeline to reactivate AI text generation with strict validation and monitoring was created and implemented for Cercles.
-   The API was temporarily stabilized by bypassing AI for problematic generators (, ) and relying on 100% reliable Python fallbacks.
-   New automated tests for API coherence and chapter mapping have been created.

However, the environment remains unstable due to a recurring dependency issue with 
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----.

**Last working item**:
-   **Last item agent was working**: Fixing the critical bug where selecting Symétrie axiale generates an unrelated exercise. The agent discovered that its previous fix was incorrect. The true root cause is twofold:
    1.  An incorrect mapping in  that linked Symétrie axiale to .
    2.  A more fundamental issue: **no generator for Symétrie axiale exists at all**.
    3.  Multiple broad  blocks in the request pipeline ( and ) were catching the chapter not found error and silently serving a generic fallback exercise instead of propagating the error to the frontend. The agent was in the process of fixing this exception handling chain.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N (The agent confirmed the error propagation locally but hasn't fixed the entire chain yet).
-   **Which testing method agent to use?**: backend testing agent to create an integration test that asserts a  or  status code is returned when requesting a chapter with no generator.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: Critical Bug - Incorrect Exercise Generation for Unmapped Chapters (P0)**
-   **Issue 2: Recurring Backend Startup Failure (P1 - Latent Blocker)**

**Issues Detail:**
-   **Issue 1:**
    -   **Description**: Selecting a chapter without a dedicated generator (e.g., Symétrie axiale) causes the API to silently return a random, unrelated exercise instead of an error. This misleads the user and breaks the core functionality.
    -   **Attempted fixes**: The agent first incorrectly mapped Symétrie axiale to other generators. It then correctly identified that no generator exists and removed the mapping. It found that broad  blocks in  (around line 2365) and  (around line 105) prevent the  from being propagated, causing a generic exercise to be generated. The agent has started to modify the exception handling but hasn't completed it.
    -   **Next debug checklist**:
        1.  Modify the  block in  (function ) to re-raise  specifically or let it propagate.
        2.  Modify the  block in  (in the  endpoint) to catch the  and raise a proper  with status code  and a clear detail message like No exercise generator available for the selected chapter.
        3.  Verify with a  test or an integration test that requesting an unmapped chapter returns the correct HTTP error and not a 200 OK with a random exercise.
    -   **Why fix this issue and what will be achieved with the fix?**: This is a critical bug that breaks user trust and core functionality. Fixing it will ensure the application behaves predictably and provides clear feedback when content is unavailable.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y (The agent's first fix was incorrect).
    -   **Should Test frontend/backend/both after fix?**: Backend.
    -   **Blocked on other issue**: None.

-   **Issue 2:**
    -   **Description**: The backend service fails to start after a container restart due to non-persistent installation of the  library, a dependency for 
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----. This makes the application inaccessible without manual agent intervention.
    -   **Attempted fixes**: The agent repeatedly ran Reading package lists...
Building dependency tree...
Reading state information.... This is a temporary fix for the current session only. A permanent solution has not been implemented.
    -   **Next debug checklist**:
        - Investigate a permanent solution, such as adding the Reading package lists...
Building dependency tree...
Reading state information...
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded. command to a startup script managed by  or to the project's Dockerfile. The user suggested a  modification.
    -   **Why fix this issue and what will be achieved with the fix?**: Although deprioritized by the user, this is a critical stability issue that will prevent the user from testing the application on their own after a restart.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Backend (verify startup without intervention).
    -   **Blocked on other issue**: None.

**In progress Task List**:
-   **Task 1: Fix Silent Error Handling for Unmapped Chapters (P0)**
    -   **Where to resume**: The agent needs to continue modifying the exception handling in  and  to ensure a  for an unmapped chapter results in an  returned to the client.
    -   **What will be achieved with this?**: The API will correctly report when content is unavailable instead of failing silently with incorrect data.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: Backend.
    -   **Blocked on something**: None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **P1: Create Content for Missing Chapters**: Implement the actual math generators for Symétrie axiale, Symétrie centrale, and other chapters that are in the curriculum but have no associated generator.
    -   **P2: Reactivate AI for Remaining Generators**: Extend the secure AI pipeline (validation, retry, fallback) to the Rectangle and Trigonométrie generators and remove them from the bypass list.
-   **Future Tasks**:
    -   Enhance the frontend with a commercial-focused landing page.

**Completed work in this session**
-   **BUG FIX: SVGs in PDF Exports**: Corrected the PDF export logic in  to copy  to , ensuring geometric figures now appear in all PDF templates.
-   **FEATURE: Comprehensive Technical Audit**: Analyzed the entire codebase and produced a detailed documentation file: .
-   **FEATURE: Secure IA Reactivation for Circles**: Implemented a robust pipeline for AI text generation for Cercles in , including:
    -   A specialized, safer prompt.
    -   A strict validation function ().
    -   An automated monitoring service () to track AI acceptance/rejection rates.
-   **REFACTOR: API Coherence Stabilization**: Temporarily bypassed AI generation for Rectangle and Trigonométrie to guarantee 100% API coherence using reliable Python fallbacks.
-   **TESTING: New Automated Test Suites**:
    -   : Checks for data consistency between figure data and AI-generated text.
    -   : An E2E test to monitor overall API coherence.
    -   : Tests the new secure IA pipeline for circles.
    -   : Initial tests for chapter mapping (needs to be updated to check for 422 errors).
    -   : Validates SVG inclusion in PDFs.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Backend Startup Failure**: The root cause (non-persistent system libraries for 
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----) has been identified and repeatedly patched temporarily, but a permanent fix has not been implemented. This remains a critical stability risk.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: The backend service failing on startup due to 
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

----- dependencies.
-   **Recurrence count**: High (occurred multiple times in this session).
-   **Status**: NOT STARTED (on a permanent solution).

**Code Architecture**


**Key Technical Concepts**
-   **Hybrid Python/AI Architecture**: Core logic in Python, text redaction by AI.
-   **Chapter-to-Generator Mapping**: A critical dictionary that maps user-facing chapter names to specific backend generator functions.
-   **Robust Exception Handling**: The need to propagate specific errors (like ) as meaningful HTTP status codes (like ) instead of catching them silently.
-   **Secure AI Pipeline**: A pattern of  to ensure data integrity.
-   **Environment Instability**: A recurring issue with non-persistent system dependencies in the containerized environment.

**key DB schema**
No database schema changes were made in this session.

**changes in tech stack**
No changes to the core tech stack.

**All files of reference**
-   **/app/backend/services/math_generation_service.py**: Contains the critical chapter-to-generator mapping logic. The agent incorrectly modified this and is now fixing it.
-   **/app/backend/server.py**: Contains high-level API logic and exception handling that is currently catching errors silently. Also contains the PDF export logic that was fixed.
-   **/app/backend/routes/math_routes.py**: The FastAPI router layer, which also has a silent  block that needs fixing.
-   **/app/backend/services/math_text_service.py**: Contains the AI calling, validation, and fallback logic. Was modified to implement the secure IA pipeline for circles.
-   **/app/AUDIT_TECHNIQUE_COMPLET.md**: A comprehensive documentation file created by the agent.
-   **/app/FIX_SVG_PDF_EXPORT.md**: A summary document for the PDF fix.

**Critical Info for New Agent**
-   Your **highest priority (P0)** is to fix the chapter mapping bug. Do not just remove the mapping; you must ensure that requesting an unmapped chapter from the API results in a  with a  status code and a clear error message. The current implementation fails silently, which is unacceptable. Investigate the  blocks in  and .
-   The root cause of the bug is that **no generator exists for Symétrie axiale**. The correct behavior is to inform the user, not generate a random exercise.
-   Be aware of the **recurring backend startup failure** due to 
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

----- dependencies. While the user has deprioritized it, it will likely happen again on the next environment restart and will block any testing. You should be prepared to apply the temporary fix () and should consider implementing the permanent fix as soon as the P0 bug is resolved.

**documents created in this job**
-   /app/AUDIT_TECHNIQUE_COMPLET.md
-   /app/REACTIVATION_IA_CERCLES.md
-   /app/FIX_SVG_PDF_EXPORT.md

**Last 10 User Messages and any pending user messages**
1.  **User:** Asks for an independent evaluation of the project's production readiness. (Completed)
2.  **User:** Reports a critical bug: selecting Symétrie axiale generates an unrelated exercise. (In Progress)
3.  **User:** Reports that SVGs are missing from PDF exports. (Completed)
4.  **User:** Reports the Symétrie axiale bug is *still* present after the agent's first attempted fix, confirming the fix was wrong and the problem is with the real API pipeline. (This is the current active issue).

**Project Health Check:**
-   **Broken**: The core feature of selecting an exercise chapter is broken for unmapped chapters, failing silently in a way that provides incorrect information to the user. The application environment is also unstable across restarts.

**3rd Party Integrations**
-   **OpenAI GPT-4o**: Uses Emergent LLM Key for exercise text generation.
-   **Stripe**: For payment processing (monthly/yearly subscriptions). Configuration inspected and confirmed correct.
-   **WeasyPrint**: For PDF generation. Source of the recurring environment instability.

**Testing status**
-   **Testing agent used after significant changes**: YES
-   **Troubleshoot agent used after agent stuck in loop**: YES
-   **Test files created**:
    -   
    -   
    -   
    -   
    -   
-   **Known regressions**: The agent's first fix for the chapter mapping introduced a different incorrect behavior before the true root cause was found.

**Credentials to test flow:**
N/A

**What agent forgot to execute**
-   The agent has repeatedly failed to implement a *permanent* solution for the 
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

----- backend startup failure, opting for a temporary Reading package lists...
Building dependency tree...
Reading state information...
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded. each time.
-   The agent's initial fix for the chapter mapping bug was incorrect because it did not test the end-to-end API flow and only relied on unit tests, leading to the user reporting the same bug again.</analysis>
