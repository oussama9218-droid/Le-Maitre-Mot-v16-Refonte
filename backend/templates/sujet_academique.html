<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ document.type_doc|title }} ‚Äî {{ document.matiere }} {{ document.niveau }}</title>
  <style>
    @page {
      size: A4;
      margin: 2cm 2cm 2cm 2cm;
      @bottom-center {
        content: "Page " counter(page) " / " counter(pages);
        font-size: 9pt;
        color: #444;
      }
    }

    body { font-family: "Times New Roman", serif; font-size: 11pt; line-height: 1.4; color: #000; }

    .header { display:grid; grid-template-columns:1fr 2fr; gap:10px; align-items:center; padding-bottom:12px; margin-bottom:16px; border-bottom:1px solid #000; }
    .logo img { max-height:70px; max-width:120px; }
    .school { text-align:right; font-size:10pt; }
    .school .school-name { font-weight:700; }

    .title { text-align:center; font-size:16pt; font-weight:700; margin:10px 0; text-transform:uppercase; }
    .subtitle { text-align:center; font-size:12pt; margin:4px 0; }

    .student-line { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; padding:8px 12px; margin:8px 0 20px 0; border:1px solid #000; font-size:10pt; }
    .field { display:flex; gap:6px; align-items:center; }
    .field label { min-width:55px; }
    .field .line { flex:1; border-bottom:1px dotted #000; height:16px; }

    .exercise { margin:0 0 20px 0; page-break-inside:avoid; }
    .exercise-header { font-weight:700; margin-bottom:6px; border-bottom:1px solid #000; padding-bottom:2px; }
    .points { font-size:10pt; font-style:italic; float:right; }
    .exercise-text { text-align:justify; margin:8px 0; }

    .answer-space { border:1px solid #000; background:#fff; margin-top:8px; }
    .answer-lines { height:3cm; background-image:repeating-linear-gradient(transparent, transparent 0.7cm, #000 0.7cm, #000 0.72cm); }

    .sep { height:1px; background:#000; margin:16px 0; opacity:.3; }

    .footer { position:fixed; bottom:0; left:0; right:0; height:30px; display:flex; align-items:center; justify-content:space-between; font-size:9pt; color:#444; border-top:1px solid #000; padding:0 1.5cm; }
    .footer-left { flex:1; }
    .footer-center { flex:1; text-align:center; }
    .footer-right { flex:1; text-align:right; font-weight:700; }

    /* QCM styling */
    .qcm-options {
      margin: 10px 0;
      padding-left: 0;
      list-style: none;
    }
    
    .qcm-options li {
      margin: 6px 0;
      padding: 4px 0;
      display: flex;
      align-items: center;
    }
    
    .qcm-options li::before {
      content: "‚òê";
      margin-right: 8px;
      font-size: 12pt;
    }
        /* NEW: Style for geometric schemas */
        .geometric-schema {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #333;
            background-color: #fafafa;
            border-radius: 8px;
        }
        
        .geometric-schema svg {
            max-width: 100%;
            height: auto;
        }
        
        /* Style for exercise figures (geometry SVG) */
        .exercise-figure {
            margin: 14px 0;
            text-align: center;
            width: 100%;
        }
        
        .exercise-figure svg {
            max-width: 100%;
            height: auto;
        }

    /* NOUVEAU: Styles pour documents g√©ographiques */
    .geographic-document {
      margin: 15px 0;
      padding: 12px;
      background-color: #f7f9fc;
      border: 2px solid #4a90e2;
      border-radius: 8px;
      page-break-inside: avoid;
    }
    
    .document-title {
      font-weight: bold;
      font-size: 15px;
      color: #2c5aa0;
      margin-bottom: 10px;
      text-align: center;
      letter-spacing: 0.5px;
    }
    
    .document-image {
      text-align: center;
      margin: 12px 0;
    }
    
    .document-attribution {
      font-size: 11px;
      color: #555;
      text-align: center;
      margin-top: 10px;
      font-style: italic;
      border-top: 1px solid #ddd;
      padding-top: 5px;
    }

  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      {% if template_config and template_config.logo_url %}
        <img src="{{ template_config.logo_url }}" alt="Logo" />
      {% endif %}
    </div>
    <div class="school">
      <div class="school-name">{{ template_config.school_name if template_config and template_config.school_name else 'Le Ma√Ætre Mot' }}</div>
      {% if template_config and template_config.professor_name %}<div>{{ template_config.professor_name }}</div>{% endif %}
      <div>{{ template_config.school_year if template_config and template_config.school_year else '2024-2025' }}</div>
    </div>
  </div>

  <div class="title">
    {% if document.type_doc == 'controle' %}Contr√¥le{% elif document.type_doc == 'dm' %}Devoir Maison{% else %}Exercices{% endif %}
  </div>
  <div class="subtitle">{{ document.matiere }} ‚Äî {{ document.niveau }} ‚Äî {{ document.chapitre }}</div>

  <div class="student-line">
    <div class="field"><label>Nom :</label><div class="line"></div></div>
    <div class="field"><label>Pr√©nom :</label><div class="line"></div></div>
    <div class="field"><label>Classe :</label><div class="line"></div></div>
    {% if document.type_doc == 'controle' %}
      <div class="field"><label>Note :</label><div class="line"></div></div>
    {% elif document.type_doc == 'dm' %}
      <div class="field"><label>Date rendu :</label><div class="line"></div></div>
    {% else %}
      <div class="field"><label>Date :</label><div class="line"></div></div>
    {% endif %}
  </div>

  {% for exercise in document.exercises or [] %}
  <div class="exercise">
    <div class="exercise-header">
      Exercice {{ loop.index }} 
      <span class="points">
        {% set total_points = (exercise.bareme or [])|sum(attribute='points') %} 
        ({{ "%.1f"|format(total_points) }} pts)
      </span>
    </div>
    <div class="exercise-text">{{ exercise.enonce | safe or '' }}
    
    <!-- NEW: Render exercise figures (geometry SVG from questions) -->
    {% if exercise.figure_html %}
        <div class="exercise-figure">
            {{ exercise.figure_html | safe }}
        </div>
    {% endif %}
    
    <!-- NEW: Render geometric schema SVG if generated -->
    {% if exercise.schema_svg %}
    <div class="geometric-schema">
        {{ exercise.schema_svg|safe }}
    </div>
    {% endif %}
    
    <!-- NOUVEAU: Geographic document -->
    {% if exercise.document %}
      <div class="geographic-document">
        <div class="document-title">üó∫Ô∏è {{ exercise.document.titre }}</div>
        
        {% if exercise.document.url_fichier_direct %}
          <div class="document-image">
            <img src="{{ exercise.document.url_fichier_direct }}" 
                 alt="{{ exercise.document.titre }}" 
                 style="max-width: 100%; max-height: 300px; margin: 10px auto; display: block; border: 1px solid #ccc;"/>
          </div>
        {% endif %}
        
        {% if exercise.document.licence and exercise.document.licence.notice_attribution %}
          <div class="document-attribution">
            <small>{{ exercise.document.licence.notice_attribution }}
            {% if exercise.document.licence.type %} ({{ exercise.document.licence.type }}){% endif %}
            </small>
          </div>
        {% endif %}
      </div>
    {% endif %}</div>
    
    {% if exercise.type == 'qcm' and exercise.donnees and exercise.donnees.options %}
      <ul class="qcm-options">
        {% for option in exercise.donnees.options %}
          <li>{{ option }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    
    <div class="answer-space"><div class="answer-lines"></div></div>
  </div>
  {% if not loop.last %}<div class="sep"></div>{% endif %}
  {% endfor %}

  <div class="footer">
    <div class="footer-left">{% if template_config and template_config.footer_text %}{{ template_config.footer_text }}{% endif %}</div>
    <div class="footer-center">{% if template_config and template_config.school_year %}{{ template_config.school_year }}{% endif %}</div>
    <div class="footer-right">Acad√©mie</div>
  </div>
</body>
</html>